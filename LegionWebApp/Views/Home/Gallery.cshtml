@using Microsoft.AspNetCore.Mvc.Localization
@using System.Globalization
@inject IViewLocalizer T
@{
	ViewData["Title"] = @T["Gallery"];
	var Gallery = new Gallery();
	int i = 1;
	<div class="container">
		@foreach (var item in Gallery.ItemList)
		{
			int pageSize;
			List<dynamic> mediaList = new List<dynamic>();

			pageSize = item.FullPage ? 12 : 6;

			if (item.Video != null)
			{
				foreach (var video in item.Video)
				{
					mediaList.Add(video);

				}
			}
			if (item.Image != null)
			{
				foreach (var image in item.Image)
				{
					mediaList.Add(image);

				}
			}

			<div class="row-cols-@pageSize">
				<div class="col-@pageSize" style="float: left; padding: 1rem;">
					<div class='card' style='background-color:rgba(255, 255, 255, 0.1);'>
						<div class='card-header text-light'>
							@item.Title
						</div>
						<div class='card-body'>
							<div class="grid-sizer"></div>
							<div class='row grid'>
								@foreach (var media in mediaList)
								{
									<div class='grid-item col-@media.Size'>
										<div class='card gallery'>
											@if (media.GetType() == typeof(Image))
											{
												<img data-src=@media.Link class="card-img-top card-img-bottom lazy" onclick="openModal();currentSlide(@i)" />
												i++;
											}
											else
											{
												<video controls preload="metadata" disablePictureInPicture controlsList="noplaybackrate nodownload lazy" class="card-img-top card-img-bottom lazyload" poster=@media.Poster>
													<source src=@media.Link type="video/mp4">
												</video>
											}
										</div>
									</div>

								}
							</div>
						</div>
					</div>
				</div>

			</div>
		}
	</div>
}
<script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.min.js"></script>
<script>
	(function() {
		function logElementEvent(eventName, element) {
			console.log(Date.now(), eventName, element.getAttribute("data-src"));
		}

		var callback_enter = function(element) {
			logElementEvent("🔑 ENTERED", element);
		};
		var callback_exit = function(element) {
			logElementEvent("🚪 EXITED", element);
		};
		var callback_loading = function(element) {
			logElementEvent("⌚ LOADING", element);
		};
		var callback_loaded = function(element) {
			logElementEvent("👍 LOADED", element);
		};
		var callback_error = function(element) {
			logElementEvent("💀 ERROR", element);
			element.src = "https://via.placeholder.com/440x560/?text=Error+Placeholder";
		};
		var callback_finish = function() {
			logElementEvent("✔️ FINISHED", document.documentElement);
		};
		var callback_cancel = function(element) {
			logElementEvent("🔥 CANCEL", element);
		};

		ll = new LazyLoad({
			// Assign the callbacks defined above
			callback_enter: callback_enter,
			callback_exit: callback_exit,
			callback_cancel: callback_cancel,
			callback_loading: callback_loading,
			callback_loaded: callback_loaded,
			callback_error: callback_error,
			callback_finish: callback_finish,
			// For debugging purposes
			threshold: 0
		});
	})();
</script>
<script>
	$.fn.videoLoaded = function() {
		var $videos = this.find('video');
		var deferred = $.Deferred();

		function checkLoaded() {
			var count = 0;
			$videos.each(function() {
				if (this.readyState === 4) {
					count++;
				}
			});
			if (count === $videos.length) {
				deferred.resolve();
			} else {
				setTimeout(checkLoaded, 50);
			}
		}
		checkLoaded();
		return deferred;
	};
</script>
<script>
	var $grid = $('.grid').masonry({
		columnWidth: $grid.find('.grid-sizer')[0],
		//fitWidth: true,
		itemSelector: '.grid-item',
		gutter: 0,
		//horizontalOrder: true
		percentPosition: true
	});

	$.when(
		//$grid.imagesLoaded(),
		$grid.videoLoaded()
	).then(function() {
		$grid.masonry('layout');
	});
</script>

<!-- Modal -->
<style>
	.fullpage {
		overflow: auto;
		display: none;
		position: fixed;
		z-index: 9999;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-size: contain;
		background-repeat: no-repeat no-repeat;
		background-position: center center;
		background-color: black;
		cursor: zoom-out;
	}

	.prev,
	.next {
		cursor: pointer;
		position: fixed;
		top: 50%;
		width: auto;
		padding: 16px;
		margin-top: -50px;
		color: white;
		font-weight: bold;
		text-decoration: none;
		font-size: 20px;
		transition: 0.6s ease;
		border-radius: 0 3px 3px 0;
		user-select: none;
		-webkit-user-select: none;
		z-index: 9999;
	}

	.next {
		right: 0;
		border-radius: 3px 0 0 3px;
	}

		.prev:hover,
		.next:hover {
			background-color: rgba(0, 0, 0, 0.8);
		}

</style>
<script>
	function CreateModal() {
		const imgs = document.querySelectorAll('.gallery img');
		var modalContent = document.getElementById("ModalContent");
		var oldHtml = modalContent.innerHTML;
		modalContent.innerHTML = "";
		imgs.forEach(img => {
			modalContent.innerHTML += '<div class="mySlides fullpage"style="background-image: url(' + img.src + ');" onclick="closeModal()"></div>';
		});
		modalContent.innerHTML += oldHtml;
	}

	function openModal() {
		CreateModal();
		document.getElementById("ModalContent").style.display = "block";
		var x = document.getElementsByTagName("BODY")[0];
		x.style.overflow = "hidden";
	}

	function closeModal() {
		document.getElementById("ModalContent").style.display = "none";
		var x = document.getElementsByTagName("BODY")[0];
		x.style.overflow = "auto";
	}

	var slideIndex = 1;
	showSlides(slideIndex);

	function plusSlides(n) {
		var numSlides = document.getElementsByClassName("mySlides").length;
		slideIndex += n;
		if (slideIndex > numSlides) {
			slideIndex = 1;
		} else if (slideIndex < 1) {
			slideIndex = numSlides;
		}
		showSlides(slideIndex);
	}

	function currentSlide(n) {
		showSlides(slideIndex = n);
	}

	function showSlides(n) {
		var i;
		var slides = document.getElementsByClassName("mySlides");
		if (n > slides.length) { slideIndex = 1 }
		if (n < 1) { slideIndex = slides.length }
		for (i = 0; i < slides.length; i++) {
			slides[i].style.display = "none";
		}
		slides[slideIndex - 1].style.display = "block";
	}
</script>

<div id="ModalContent" class="modal" ontouchstart="touchStart(event)" ontouchmove="touchMove(event)" ontouchend="touchEnd(event)">
	<a class="prev" onclick="plusSlides(-1)">&#10094;</a>
	<a class="next" onclick="plusSlides(1)">&#10095;</a>
</div>

<script>
	document.addEventListener('keydown', (event) => {
		switch (event.keyCode) {
			case 37:
				plusSlides(-1);
				break;
			case 39:
				plusSlides(1);
				break;
			case 38:
				// Up arrow key
				closeModal();
				break;
			case 40:
				// Down arrow key
				closeModal();
				break;
		}
	});
</script>
<script>
	let xDown = null;
	let yDown = null;

	function touchStart(event) {
		xDown = event.touches[0].clientX;
		yDown = event.touches[0].clientY;
	}

	function touchMove(event) {
		if (!xDown || !yDown) {
			return;
		}

		const xUp = event.touches[0].clientX;
		const yUp = event.touches[0].clientY;

		const xDiff = xDown - xUp;
		const yDiff = yDown - yUp;

		// Minimum distance to swipe before changing slides
		const threshold = 5;

		if (Math.abs(xDiff) > Math.abs(yDiff)) {
			if (Math.abs(xDiff) > threshold) {
				if (xDiff > 0) {
					// Left swipe
					plusSlides(1);
				} else {
					// Right swipe
					plusSlides(-1);
				}
			}
		} else {
			if (Math.abs(yDiff) > threshold) {
				if (yDiff > 0) {
					// Up swipe or up arrow key
					closeModal();
				} else {
					// Down swipe or down arrow key
					closeModal();
				}
			}
		}

		xDown = null;
		yDown = null;
	}

	function touchEnd(event) {
		xDown = null;
		yDown = null;
	}
</script>
<!-- Modal End -->